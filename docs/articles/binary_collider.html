<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Collider bias for binary variables • AscRtain</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Collider bias for binary variables">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">AscRtain</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/binary_collider.html">Collider bias for binary variables</a>
    </li>
    <li>
      <a href="../articles/collider_ascertainment.html">Ascertainment on a collider</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/explodecomputer/AscRtain">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Collider bias for binary variables</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/explodecomputer/AscRtain/blob/master/vignettes/binary_collider.Rmd"><code>vignettes/binary_collider.Rmd</code></a></small>
      <div class="hidden name"><code>binary_collider.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(AscRtain)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggnewscale)</span></code></pre></div>
<p>Following <a href="https://osf.io/vrcuf/" class="uri">https://osf.io/vrcuf/</a>, can infer the biased OR for a binary exposure (<span class="math inline">\(A\)</span>) on a binary outcome (<span class="math inline">\(Y\)</span>) when both of the traits influence the probability of being present in the sample (<span class="math inline">\(S\)</span>)</p>
<p>Assume that being present in the sample is simply:</p>
<p><span class="math display">\[
\mathbb{P}(S = 1 | A,Y) = \beta_0 + \beta_A A + \beta_Y Y + \beta_{AY} AY
\]</span></p>
<p>where <span class="math inline">\(A = {0,1}\)</span> and <span class="math inline">\(Y = {0,1}\)</span>. The expected odds ratio under this scenario is then:</p>
<p><span class="math display">\[
\mathbb{E}\left[\widehat{\operatorname{OR}}_{S=1}\right] = \frac{\beta_0(\beta_0 + \beta_A + \beta_Y + \beta_{AY})}{(\beta_0 + \beta_A)(\beta_0 + \beta_Y)}
\]</span></p>
<p>Suppose that we know the fraction of the population that is present in our sample (<span class="math inline">\(p_{S}\)</span>). We are only interested in the <span class="math inline">\(\beta_*\)</span> parameter values that give rise to a value of <span class="math inline">\(p_{S}\)</span> that is within the bounds of expectation:</p>
<p><span class="math display">\[
p_{S} = \beta_0 + \beta_A p_A + \beta_Y p_Y + \beta_{AY} p_{AY}
\]</span></p>
<p>Scenario: we find an association between <span class="math inline">\(A\)</span> and <span class="math inline">\(Y\)</span> in our ascertained sample. Our question is what effects must <span class="math inline">\(A\)</span> and <span class="math inline">\(Y\)</span> have on sample ascertainment in order to induce the observed odds ratio <span class="math inline">\(\operatorname{OR}\)</span>, assuming that the true odds ratio is 1.</p>
<p>Initialise a new <code>VBB</code> (<strong>V</strong>-structure, <strong>B</strong>inary exposure, <strong>B</strong>inary outcome) class</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>x &lt;-<span class="st"> </span>VBB<span class="op">$</span><span class="kw">new</span>()</span>
<span id="cb2-2"><a href="#cb2-2"></a>x</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co">#&gt; &lt;VBB&gt;</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="co">#&gt;   Public:</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="co">#&gt;     clone: function (deep = FALSE) </span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="co">#&gt;     histogram: function (bins = 30) </span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="co">#&gt;     or_calc: function (b0, ba, by, bay) </span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co">#&gt;     param: NULL</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="co">#&gt;     parameter_space: function (target_or, pS, pA, pY, pAY, b0_range, ba_range, by_range, </span></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="co">#&gt;     ps_calc: function (b0, ba, by, bay, pA, pY, pAY) </span></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="co">#&gt;     scatter: function () </span></span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="co">#&gt;     scatter3d: function (ticktype = "detailed", theta = 130, phi = 0, bty = "g",</span></span></code></pre></div>
<p>Example of how to calculate the odds ratio for given <span class="math inline">\(\beta_*\)</span> parameters:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>x<span class="op">$</span><span class="kw">or_calc</span>(<span class="dt">b0=</span><span class="fl">0.1</span>, <span class="dt">ba=</span><span class="fl">0.2</span>, <span class="dt">by=</span><span class="fl">0.3</span>, <span class="dt">bay=</span><span class="fl">0.4</span>)</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co">#&gt; [1] 0.8333333</span></span></code></pre></div>
<p>Search over a parameter space of possible values to identify whether some target odds ratio could be explained by sample ascertainment</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>x<span class="op">$</span><span class="kw">parameter_space</span>(</span>
<span id="cb4-2"><a href="#cb4-2"></a>    <span class="dt">target_or=</span><span class="dv">2</span>, </span>
<span id="cb4-3"><a href="#cb4-3"></a>    <span class="dt">pS=</span><span class="fl">0.0275</span>, </span>
<span id="cb4-4"><a href="#cb4-4"></a>    <span class="dt">pA=</span><span class="fl">0.15</span>,</span>
<span id="cb4-5"><a href="#cb4-5"></a>    <span class="dt">pY=</span><span class="fl">0.1</span>,</span>
<span id="cb4-6"><a href="#cb4-6"></a>    <span class="dt">pAY=</span><span class="dv">0</span>,</span>
<span id="cb4-7"><a href="#cb4-7"></a>    <span class="dt">b0_range=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="fl">0.1</span>), </span>
<span id="cb4-8"><a href="#cb4-8"></a>    <span class="dt">ba_range=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">0.2</span>,<span class="fl">0.2</span>), </span>
<span id="cb4-9"><a href="#cb4-9"></a>    <span class="dt">by_range=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">0.2</span>,<span class="fl">0.2</span>), </span>
<span id="cb4-10"><a href="#cb4-10"></a>    <span class="dt">bay_range=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">0</span>), </span>
<span id="cb4-11"><a href="#cb4-11"></a>    <span class="dt">granularity=</span><span class="dv">200</span></span>
<span id="cb4-12"><a href="#cb4-12"></a>)</span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="co">#&gt; 8000000 parameter combinations</span></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="co">#&gt; 184710 within pS_tol</span></span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="co">#&gt; 6770 beyond OR threshold</span></span></code></pre></div>
<p>The parameter values that meet the target OR due to collider bias</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>x<span class="op">$</span>param</span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co">#&gt; # A tibble: 6,770 x 9</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="co">#&gt;       pA    pY   pAY     b0      ba      by   bay    ps1    or</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="co">#&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="co">#&gt;  1  0.15   0.1     0 0.0317 0.00101 -0.0312     0 0.0287  2.91</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="co">#&gt;  2  0.15   0.1     0 0.0317 0.00302 -0.0312     0 0.0290  6.39</span></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="co">#&gt;  3  0.15   0.1     0 0.0322 0.00302 -0.0312     0 0.0295  3.66</span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="co">#&gt;  4  0.15   0.1     0 0.0317 0.00503 -0.0312     0 0.0293  9.49</span></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="co">#&gt;  5  0.15   0.1     0 0.0322 0.00503 -0.0312     0 0.0298  5.19</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="co">#&gt;  6  0.15   0.1     0 0.0317 0.00704 -0.0312     0 0.0296 12.3 </span></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="co">#&gt;  7  0.15   0.1     0 0.0317 0.00905 -0.0312     0 0.0299 14.8 </span></span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="co">#&gt;  8  0.15   0.1     0 0.0296 0.00101 -0.0291     0 0.0269  2.90</span></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="co">#&gt;  9  0.15   0.1     0 0.0296 0.00302 -0.0291     0 0.0272  6.35</span></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="co">#&gt; 10  0.15   0.1     0 0.0302 0.00302 -0.0291     0 0.0277  3.64</span></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="co">#&gt; # … with 6,760 more rows</span></span></code></pre></div>
<p>Visualise the distribution of odds ratios found across the range of parameters</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>x<span class="op">$</span><span class="kw">histogram</span>()</span></code></pre></div>
<p><img src="binary_collider_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>Visualise the <span class="math inline">\(\beta_*\)</span> parameter ranges that meet the target odds ratio</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>x<span class="op">$</span><span class="kw">scatter</span>()</span></code></pre></div>
<p><img src="binary_collider_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>Or in 3D:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>x<span class="op">$</span><span class="kw">scatter3d</span>()</span></code></pre></div>
<p><img src="binary_collider_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>Can try to do this in 3D also:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>plot3Drgl<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/plot3Drgl/man/plotrgl.html">plotrgl</a></span>()</span></code></pre></div>
<div id="ace-inhibitor-and-covid19-association" class="section level2">
<h2 class="hasAnchor">
<a href="#ace-inhibitor-and-covid19-association" class="anchor"></a>ACE-inhibitor and COVID19 association</h2>
<p>Here, <span class="math inline">\(A\)</span> is ACE inhibitor use, <span class="math inline">\(Y\)</span> is Covid-19 status, and <span class="math inline">\(S\)</span> is presence in the first release of the COVID Symptom Tracker dataset.</p>
<p>Observational association of ACE-i influence on Covid-19 status gives OR <span class="math inline">\(\approx 2\)</span>. Assume 7.8% of population take ACE-i, 10% are infected with coronavirus at the time of sampling, 1.9 million of an adult population of 54 million are present in the sample (3.5%). What influences of ACE-inhibitor use and Covid-19 status would be required to induce a collider bias of <span class="math inline">\(\operatorname{OR}=2\)</span>?</p>
<p>Enter parameters without interactions to reduce the paramater space for now:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>x &lt;-<span class="st"> </span>VBB<span class="op">$</span><span class="kw">new</span>()</span>
<span id="cb10-2"><a href="#cb10-2"></a>x<span class="op">$</span><span class="kw">parameter_space</span>(  </span>
<span id="cb10-3"><a href="#cb10-3"></a>    <span class="dt">target_or=</span><span class="fl">2.07</span>, </span>
<span id="cb10-4"><a href="#cb10-4"></a>    <span class="dt">pS=</span><span class="fl">0.035</span>, </span>
<span id="cb10-5"><a href="#cb10-5"></a>    <span class="dt">pA=</span><span class="fl">0.078</span>,</span>
<span id="cb10-6"><a href="#cb10-6"></a>    <span class="dt">pY=</span><span class="fl">0.1</span>,</span>
<span id="cb10-7"><a href="#cb10-7"></a>    <span class="dt">pAY=</span><span class="fl">0.03</span>,</span>
<span id="cb10-8"><a href="#cb10-8"></a>    <span class="dt">b0_range=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="fl">0.1</span>), </span>
<span id="cb10-9"><a href="#cb10-9"></a>    <span class="dt">ba_range=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">0.1</span>,<span class="fl">0.1</span>), </span>
<span id="cb10-10"><a href="#cb10-10"></a>    <span class="dt">by_range=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">0.2</span>,<span class="fl">0.2</span>), </span>
<span id="cb10-11"><a href="#cb10-11"></a>    <span class="dt">bay_range=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">0</span>), </span>
<span id="cb10-12"><a href="#cb10-12"></a>    <span class="dt">granularity=</span><span class="dv">200</span></span>
<span id="cb10-13"><a href="#cb10-13"></a>)</span>
<span id="cb10-14"><a href="#cb10-14"></a><span class="co">#&gt; 8000000 parameter combinations</span></span>
<span id="cb10-15"><a href="#cb10-15"></a><span class="co">#&gt; 237607 within pS_tol</span></span>
<span id="cb10-16"><a href="#cb10-16"></a><span class="co">#&gt; 15775 beyond OR threshold</span></span>
<span id="cb10-17"><a href="#cb10-17"></a>x<span class="op">$</span><span class="kw">scatter</span>()</span></code></pre></div>
<p><img src="binary_collider_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>Within our sample the prevalence of ACEi use is 4.2%. In the general population it is 7.8%. This means we can narrow down the range of our simulations to only look at parameter values that would give that level of selection (reduced likelihood of selection when on ACEi).</p>
<p>Need to figure out what value of <span class="math inline">\(\beta_A\)</span> could give rise to the difference in prevalences between population and sample/</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">20200420</span>)</span>
<span id="cb11-2"><a href="#cb11-2"></a>n &lt;-<span class="st"> </span><span class="dv">1000000</span></span>
<span id="cb11-3"><a href="#cb11-3"></a>Y &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(n, <span class="dv">1</span>, <span class="fl">0.1</span>)</span>
<span id="cb11-4"><a href="#cb11-4"></a>A &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(n, <span class="dv">1</span>, <span class="fl">0.078</span>)</span>
<span id="cb11-5"><a href="#cb11-5"></a>pS &lt;-<span class="st"> </span><span class="fl">0.03</span> <span class="op">-</span><span class="st"> </span><span class="fl">0.015</span> <span class="op">*</span><span class="st"> </span>A <span class="op">+</span><span class="st"> </span><span class="fl">0.1</span> <span class="op">*</span><span class="st"> </span>Y</span>
<span id="cb11-6"><a href="#cb11-6"></a>S &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(n, <span class="dv">1</span>, pS)</span>
<span id="cb11-7"><a href="#cb11-7"></a></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="co"># target 4.2% in sample</span></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="co"># assume 7.8% in uk</span></span>
<span id="cb11-10"><a href="#cb11-10"></a>dat &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/reexports.html">tibble</a></span>(A,Y,S)</span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="kw"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(dat, S<span class="op">==</span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span>{<span class="kw"><a href="https://rdrr.io/r/base/table.html">table</a></span>(.<span class="op">$</span>A)<span class="op">/</span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(.<span class="op">$</span>S)}</span>
<span id="cb11-12"><a href="#cb11-12"></a><span class="co">#&gt; </span></span>
<span id="cb11-13"><a href="#cb11-13"></a><span class="co">#&gt;         0         1 </span></span>
<span id="cb11-14"><a href="#cb11-14"></a><span class="co">#&gt; 0.9503764 0.0496236</span></span></code></pre></div>
<p>Likely somewhere between <span class="math inline">\(-0.1\)</span> and <span class="math inline">\(-0.2\)</span>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>x<span class="op">$</span><span class="kw">scatter</span>() <span class="op">+</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>ggplot2<span class="op">::</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="dt">x =</span> <span class="kw"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Effect of ACE-i on inclusion probability ("</span>, beta[A],<span class="st">")"</span>)), </span>
<span id="cb12-3"><a href="#cb12-3"></a>              <span class="dt">y =</span> <span class="kw"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Effect of Covid-19 on inclusion probability ("</span>, beta[Y],<span class="st">")"</span>)), </span>
<span id="cb12-4"><a href="#cb12-4"></a>              <span class="dt">colour =</span> <span class="kw"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Baseline inc. prob. "</span>, (beta[<span class="dv">0</span>])))) <span class="op">+</span></span>
<span id="cb12-5"><a href="#cb12-5"></a>ggplot2<span class="op">::</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(<span class="st">"rect"</span>, <span class="dt">xmin=</span><span class="op">-</span><span class="fl">0.01</span>, <span class="dt">xmax=</span><span class="op">-</span><span class="fl">0.02</span>, <span class="dt">ymin=</span><span class="op">-</span><span class="ot">Inf</span>, <span class="dt">ymax=</span><span class="ot">Inf</span>, <span class="dt">alpha=</span><span class="fl">0.4</span>)</span></code></pre></div>
<p><img src="binary_collider_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<p>Now that we can fix the <span class="math inline">\(\beta_A\)</span> parameter to 0.015, we can introduce the interaction effect. Here, if somebody is a case for COVID and uses ACEi do they have a different probability of selection than just the marginal effects.</p>
<p>We can also ask - is our association actually more likely to be attenuated to OR=2, rather than inflated from OR=1. Let’s search the parameter space for parameter sets that give OR=0.8 and superimpose on the figure.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>x &lt;-<span class="st"> </span>VBB<span class="op">$</span><span class="kw">new</span>()</span>
<span id="cb13-2"><a href="#cb13-2"></a>x<span class="op">$</span><span class="kw">parameter_space</span>(  </span>
<span id="cb13-3"><a href="#cb13-3"></a>    <span class="dt">target_or=</span><span class="fl">1.95</span>, </span>
<span id="cb13-4"><a href="#cb13-4"></a>    <span class="dt">pS=</span><span class="fl">0.035</span>, </span>
<span id="cb13-5"><a href="#cb13-5"></a>    <span class="dt">pA=</span><span class="fl">0.078</span>,</span>
<span id="cb13-6"><a href="#cb13-6"></a>    <span class="dt">pY=</span><span class="fl">0.1</span>,</span>
<span id="cb13-7"><a href="#cb13-7"></a>    <span class="dt">pAY=</span><span class="fl">0.078</span> <span class="op">*</span><span class="st"> </span><span class="fl">0.1</span>,</span>
<span id="cb13-8"><a href="#cb13-8"></a>    <span class="dt">b0_range=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="fl">0.1</span>), </span>
<span id="cb13-9"><a href="#cb13-9"></a>    <span class="dt">ba_range=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">0.015</span>, <span class="fl">-0.015</span>), </span>
<span id="cb13-10"><a href="#cb13-10"></a>    <span class="dt">by_range=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">0.1</span>,<span class="fl">0.1</span>), </span>
<span id="cb13-11"><a href="#cb13-11"></a>    <span class="dt">bay_range=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">0.1</span>,<span class="fl">0.1</span>), </span>
<span id="cb13-12"><a href="#cb13-12"></a>    <span class="dt">granularity=</span><span class="dv">200</span></span>
<span id="cb13-13"><a href="#cb13-13"></a>)</span>
<span id="cb13-14"><a href="#cb13-14"></a><span class="co">#&gt; 8000000 parameter combinations</span></span>
<span id="cb13-15"><a href="#cb13-15"></a><span class="co">#&gt; 240761 within pS_tol</span></span>
<span id="cb13-16"><a href="#cb13-16"></a><span class="co">#&gt; 117920 beyond OR threshold</span></span>
<span id="cb13-17"><a href="#cb13-17"></a></span>
<span id="cb13-18"><a href="#cb13-18"></a>x1 &lt;-<span class="st"> </span>VBB<span class="op">$</span><span class="kw">new</span>()</span>
<span id="cb13-19"><a href="#cb13-19"></a>x1<span class="op">$</span><span class="kw">parameter_space</span>( </span>
<span id="cb13-20"><a href="#cb13-20"></a>    <span class="dt">target_or=</span><span class="fl">0.8</span>, </span>
<span id="cb13-21"><a href="#cb13-21"></a>    <span class="dt">pS=</span><span class="fl">0.035</span>, </span>
<span id="cb13-22"><a href="#cb13-22"></a>    <span class="dt">pA=</span><span class="fl">0.078</span>,</span>
<span id="cb13-23"><a href="#cb13-23"></a>    <span class="dt">pY=</span><span class="fl">0.1</span>,</span>
<span id="cb13-24"><a href="#cb13-24"></a>    <span class="dt">pAY=</span><span class="fl">0.078</span> <span class="op">*</span><span class="st"> </span><span class="fl">0.1</span>,</span>
<span id="cb13-25"><a href="#cb13-25"></a>    <span class="dt">b0_range=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="fl">0.1</span>), </span>
<span id="cb13-26"><a href="#cb13-26"></a>    <span class="dt">ba_range=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">0.015</span>, <span class="fl">-0.015</span>), </span>
<span id="cb13-27"><a href="#cb13-27"></a>    <span class="dt">by_range=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">0.1</span>,<span class="fl">0.1</span>), </span>
<span id="cb13-28"><a href="#cb13-28"></a>    <span class="dt">bay_range=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">0.1</span>,<span class="fl">0.1</span>), </span>
<span id="cb13-29"><a href="#cb13-29"></a>    <span class="dt">granularity=</span><span class="dv">200</span></span>
<span id="cb13-30"><a href="#cb13-30"></a>)</span>
<span id="cb13-31"><a href="#cb13-31"></a><span class="co">#&gt; 8000000 parameter combinations</span></span>
<span id="cb13-32"><a href="#cb13-32"></a><span class="co">#&gt; 240761 within pS_tol</span></span>
<span id="cb13-33"><a href="#cb13-33"></a><span class="co">#&gt; 35758 beyond OR threshold</span></span>
<span id="cb13-34"><a href="#cb13-34"></a></span>
<span id="cb13-35"><a href="#cb13-35"></a>x<span class="op">$</span>param <span class="op">%&gt;%</span><span class="st"> </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(., <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> bay, <span class="dt">y =</span> by)) <span class="op">+</span></span>
<span id="cb13-36"><a href="#cb13-36"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">colour =</span> b0)) <span class="op">+</span></span>
<span id="cb13-37"><a href="#cb13-37"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="dt">colour =</span> <span class="kw"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Baseline inc. prob. "</span>, (beta[<span class="dv">0</span>]), <span class="st">" OR &gt; 2"</span>))) <span class="op">+</span></span>
<span id="cb13-38"><a href="#cb13-38"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_colour_gradient</a></span>(<span class="dt">low=</span><span class="st">"white"</span>, <span class="dt">high=</span><span class="st">"blue"</span>) <span class="op">+</span></span>
<span id="cb13-39"><a href="#cb13-39"></a><span class="st">  </span>ggnewscale<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/ggnewscale/man/new_scale.html">new_scale_colour</a></span>() <span class="op">+</span></span>
<span id="cb13-40"><a href="#cb13-40"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="dt">data =</span> x1<span class="op">$</span>param, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">colour =</span> b0)) <span class="op">+</span></span>
<span id="cb13-41"><a href="#cb13-41"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_colour_gradient</a></span>(<span class="dt">low =</span> <span class="st">"white"</span>, <span class="dt">high =</span> <span class="st">"red"</span>) <span class="op">+</span></span>
<span id="cb13-42"><a href="#cb13-42"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="dt">x =</span> <span class="kw"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Effect of ACE-i AND Covid-19 on inclusion probability ("</span>, beta[AY],<span class="st">")"</span>)), </span>
<span id="cb13-43"><a href="#cb13-43"></a>                <span class="dt">y =</span> <span class="kw"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Effect of Covid-19 on inclusion probability ("</span>, beta[Y], <span class="st">")"</span>)), </span>
<span id="cb13-44"><a href="#cb13-44"></a>                <span class="dt">colour =</span> <span class="kw"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Baseline inc. prob. "</span>, (beta[<span class="dv">0</span>]), <span class="st">" OR &lt; 0.8"</span>)))</span></code></pre></div>
<p><img src="binary_collider_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<p>So it could go either way really, a lot of the figure is shaded in both blue and red, and we don’t know what the actual selection based on covid is. This indicates that it is really not reliable to be making claims about causality from this type of sampling.</p>
<p>Note that some areas of the figure have both negative and positive bias - that is because it changes with different levels of background participation (<span class="math inline">\(\beta_0\)</span>). This parameter is particularly difficult to estimate what the likely true value is.</p>
</div>
<div id="simulate-to-check" class="section level2">
<h2 class="hasAnchor">
<a href="#simulate-to-check" class="anchor"></a>Simulate to check</h2>
<p>Simulate individual level data according to the first result, where <span class="math inline">\(A\)</span> has no influence on <span class="math inline">\(Y\)</span>. Note that using a population size of 1 million as the sample size doesn’t matter, just the proportion sampled.</p>
<p>Parameters:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>a &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(x<span class="op">$</span>param, ba <span class="op">&lt;</span><span class="st"> </span><span class="fl">-0.01</span> <span class="op">&amp;</span><span class="st"> </span>ba <span class="op">&gt;</span><span class="st"> </span><span class="fl">-0.02</span> <span class="op">&amp;</span><span class="st"> </span>bay <span class="op">==</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(bay)))[<span class="dv">1</span>,]</span>
<span id="cb14-2"><a href="#cb14-2"></a>a</span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="co">#&gt; # A tibble: 1 x 9</span></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="co">#&gt;      pA    pY    pAY     b0     ba     by      bay    ps1    or</span></span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="co">#&gt; 1 0.078   0.1 0.0078 0.0266 -0.015 0.0719 0.000503 0.0327  1.95</span></span></code></pre></div>
<p>Simulate</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">31415</span>)</span>
<span id="cb15-2"><a href="#cb15-2"></a>n &lt;-<span class="st"> </span><span class="dv">1000000</span></span>
<span id="cb15-3"><a href="#cb15-3"></a>Y &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(n, <span class="dv">1</span>, a<span class="op">$</span>pY)</span>
<span id="cb15-4"><a href="#cb15-4"></a>A &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(n, <span class="dv">1</span>, a<span class="op">$</span>pA)</span>
<span id="cb15-5"><a href="#cb15-5"></a>pS &lt;-<span class="st"> </span>a<span class="op">$</span>b0 <span class="op">+</span><span class="st"> </span>a<span class="op">$</span>ba <span class="op">*</span><span class="st"> </span>A <span class="op">+</span><span class="st"> </span>a<span class="op">$</span>by <span class="op">*</span><span class="st"> </span>Y</span>
<span id="cb15-6"><a href="#cb15-6"></a>S &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(n, <span class="dv">1</span>, pS)</span></code></pre></div>
<p>What proportion of the population are present in the sample?</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(S) <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(S)</span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="co">#&gt; [1] 0.032824</span></span></code></pre></div>
<p>Estimate association between <code>A</code> and <code>Y</code></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(Y <span class="op">~</span><span class="st"> </span>A, <span class="dt">family=</span><span class="st">"binomial"</span>, <span class="dt">subset=</span>S<span class="op">==</span><span class="dv">1</span>))<span class="op">$</span>coef[<span class="dv">2</span>,<span class="dv">1</span>] <span class="op">%&gt;%</span><span class="st"> </span>exp</span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="co">#&gt; [1] 1.933545</span></span></code></pre></div>
<p>Compare to expected biased association</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>a<span class="op">$</span>or</span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="co">#&gt; [1] 1.952429</span></span></code></pre></div>
</div>
<div id="weighted-regression-to-correct-for-bias" class="section level2">
<h2 class="hasAnchor">
<a href="#weighted-regression-to-correct-for-bias" class="anchor"></a>Weighted regression to correct for bias</h2>
<p>If a logistic regression in the complete population could be performed to estimate the effect of <span class="math inline">\(A\)</span> and <span class="math inline">\(Y\)</span> on <span class="math inline">\(S\)</span> then inverse probability weighting could be achieved by</p>
<ol style="list-style-type: decimal">
<li>Estimating the log odds ratios of <span class="math inline">\(A\)</span>, <span class="math inline">\(Y\)</span> and <span class="math inline">\(A*Y\)</span> (and the intercept) on <span class="math inline">\(S\)</span>.</li>
<li>Generate the fitted values</li>
<li>Convert to probabilities (e.g. using the logistic distribution)</li>
</ol>
<p>The inverse of these probabilities are the weights to be used in logistic regression in the ascertained sample:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>probs &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(S <span class="op">~</span><span class="st"> </span>A <span class="op">+</span><span class="st"> </span>Y <span class="op">+</span><span class="st"> </span>A<span class="op">:</span>Y, <span class="dt">family=</span><span class="st">"binomial"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/fitted.values.html">fitted.values</a></span>()</span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="kw"><a href="https://rdrr.io/r/base/table.html">table</a></span>(probs)</span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="co">#&gt; probs</span></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="co">#&gt; 0.0116860009957589 0.0268861156313915 0.0810912748254119 </span></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="co">#&gt;              70255             829350               7954 </span></span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="co">#&gt;   0.09800845944596 </span></span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="co">#&gt;              92441</span></span></code></pre></div>
<p>Associations in ascertained sample (biased):</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(Y <span class="op">~</span><span class="st"> </span>A, <span class="dt">family=</span><span class="st">"binomial"</span>, <span class="dt">subset=</span>S<span class="op">==</span><span class="dv">1</span>))<span class="op">$</span>coef[<span class="dv">2</span>] <span class="op">%&gt;%</span><span class="st"> </span>exp</span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="co">#&gt; [1] 1.933545</span></span></code></pre></div>
<p>Associations in total population (unbiased):</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(Y <span class="op">~</span><span class="st"> </span>A, <span class="dt">family=</span><span class="st">"binomial"</span>))<span class="op">$</span>coef[<span class="dv">2</span>] <span class="op">%&gt;%</span><span class="st"> </span>exp</span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="co">#&gt; [1] 1.015738</span></span></code></pre></div>
<p>Weighted regression in ascertained sample (unbiased):</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(Y <span class="op">~</span><span class="st"> </span>A, <span class="dt">family=</span><span class="st">"binomial"</span>, <span class="dt">subset=</span>S<span class="op">==</span><span class="dv">1</span>, <span class="dt">weight=</span><span class="dv">1</span><span class="op">/</span>probs))<span class="op">$</span>coef[<span class="dv">2</span>] <span class="op">%&gt;%</span><span class="st"> </span>exp</span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="co">#&gt; Warning in eval(family$initialize): non-integer #successes in a binomial</span></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="co">#&gt; glm!</span></span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="co">#&gt; [1] 1.015738</span></span></code></pre></div>
<p>However, not having the complete population data available means we cannot actually estimate the effects of A and Y on S directly. If we did know those effects (on the log OR scale), then the weights are easily generated:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>coef &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(S <span class="op">~</span><span class="st"> </span>A <span class="op">+</span><span class="st"> </span>Y <span class="op">+</span><span class="st"> </span>A<span class="op">:</span>Y, <span class="dt">family=</span><span class="st">"binomial"</span>)<span class="op">$</span>coef</span>
<span id="cb23-2"><a href="#cb23-2"></a>probs2 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span>(<span class="op">~</span><span class="st"> </span>A <span class="op">+</span><span class="st"> </span>Y <span class="op">+</span><span class="st"> </span>A<span class="op">:</span>Y, <span class="dt">subset=</span>S<span class="op">==</span><span class="dv">1</span>) <span class="op">%*%</span><span class="st"> </span>coef <span class="op">%&gt;%</span><span class="st"> </span>plogis</span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(Y <span class="op">~</span><span class="st"> </span>A, <span class="dt">family=</span><span class="st">"binomial"</span>, <span class="dt">subset=</span>S<span class="op">==</span><span class="dv">1</span>, <span class="dt">weight=</span><span class="dv">1</span><span class="op">/</span>probs2))<span class="op">$</span>coef[<span class="dv">2</span>] <span class="op">%&gt;%</span><span class="st"> </span>exp</span>
<span id="cb23-4"><a href="#cb23-4"></a><span class="co">#&gt; Warning in eval(family$initialize): non-integer #successes in a binomial</span></span>
<span id="cb23-5"><a href="#cb23-5"></a><span class="co">#&gt; glm!</span></span>
<span id="cb23-6"><a href="#cb23-6"></a><span class="co">#&gt; [1] 1.015738</span></span></code></pre></div>
<p>Instead, we have a set of parameters that we know give rise to bias. There is a slight complication in that those parameters are in terms of risk difference, not log odds ratios. So we need to convert them:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a><span class="co"># Define the case fraction</span></span>
<span id="cb24-2"><a href="#cb24-2"></a>mu &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(S) <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(S)</span>
<span id="cb24-3"><a href="#cb24-3"></a>coef2 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(</span>
<span id="cb24-4"><a href="#cb24-4"></a>    <span class="kw"><a href="https://rdrr.io/r/stats/Logistic.html">qlogis</a></span>(a<span class="op">$</span>b0),</span>
<span id="cb24-5"><a href="#cb24-5"></a>    a<span class="op">$</span>ba <span class="op">/</span><span class="st"> </span>(mu <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span><span class="op">-</span>mu)),</span>
<span id="cb24-6"><a href="#cb24-6"></a>    a<span class="op">$</span>by <span class="op">/</span><span class="st"> </span>(mu <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span><span class="op">-</span>mu)),</span>
<span id="cb24-7"><a href="#cb24-7"></a>    a<span class="op">$</span>bay <span class="op">/</span><span class="st"> </span>(mu <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span><span class="op">-</span>mu))</span>
<span id="cb24-8"><a href="#cb24-8"></a>)</span>
<span id="cb24-9"><a href="#cb24-9"></a>probs3 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span>(<span class="op">~</span><span class="st"> </span>A <span class="op">+</span><span class="st"> </span>Y <span class="op">+</span><span class="st"> </span>A<span class="op">:</span>Y, <span class="dt">subset=</span>S<span class="op">==</span><span class="dv">1</span>) <span class="op">%*%</span><span class="st"> </span>coef2 <span class="op">%&gt;%</span><span class="st"> </span>plogis</span>
<span id="cb24-10"><a href="#cb24-10"></a><span class="kw"><a href="https://rdrr.io/r/base/table.html">table</a></span>(probs3)</span>
<span id="cb24-11"><a href="#cb24-11"></a><span class="co">#&gt; probs3</span></span>
<span id="cb24-12"><a href="#cb24-12"></a><span class="co">#&gt; 0.0167725721021214 0.0266331658291457  0.142859740482955 </span></span>
<span id="cb24-13"><a href="#cb24-13"></a><span class="co">#&gt;              70255             829350               7954 </span></span>
<span id="cb24-14"><a href="#cb24-14"></a><span class="co">#&gt;  0.208321080367101 </span></span>
<span id="cb24-15"><a href="#cb24-15"></a><span class="co">#&gt;              92441</span></span>
<span id="cb24-16"><a href="#cb24-16"></a><span class="kw"><a href="https://rdrr.io/r/base/table.html">table</a></span>(probs2)</span>
<span id="cb24-17"><a href="#cb24-17"></a><span class="co">#&gt; probs2</span></span>
<span id="cb24-18"><a href="#cb24-18"></a><span class="co">#&gt; 0.0116860009957589 0.0268861156313915 0.0810912748254119 </span></span>
<span id="cb24-19"><a href="#cb24-19"></a><span class="co">#&gt;              70255             829350               7954 </span></span>
<span id="cb24-20"><a href="#cb24-20"></a><span class="co">#&gt;   0.09800845944596 </span></span>
<span id="cb24-21"><a href="#cb24-21"></a><span class="co">#&gt;              92441</span></span>
<span id="cb24-22"><a href="#cb24-22"></a><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(Y <span class="op">~</span><span class="st"> </span>A, <span class="dt">family=</span><span class="st">"binomial"</span>, <span class="dt">subset=</span>S<span class="op">==</span><span class="dv">1</span>, <span class="dt">weight=</span><span class="dv">1</span><span class="op">/</span>probs3))<span class="op">$</span>coef[<span class="dv">2</span>] <span class="op">%&gt;%</span><span class="st"> </span>exp</span>
<span id="cb24-23"><a href="#cb24-23"></a><span class="co">#&gt; Warning in eval(family$initialize): non-integer #successes in a binomial</span></span>
<span id="cb24-24"><a href="#cb24-24"></a><span class="co">#&gt; glm!</span></span>
<span id="cb24-25"><a href="#cb24-25"></a><span class="co">#&gt; [1] 1.775638</span></span>
<span id="cb24-26"><a href="#cb24-26"></a><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(Y <span class="op">~</span><span class="st"> </span>A, <span class="dt">family=</span><span class="st">"binomial"</span>, <span class="dt">subset=</span>S<span class="op">==</span><span class="dv">1</span>))<span class="op">$</span>coef[<span class="dv">2</span>] <span class="op">%&gt;%</span><span class="st"> </span>exp</span>
<span id="cb24-27"><a href="#cb24-27"></a><span class="co">#&gt; [1] 1.933545</span></span></code></pre></div>
<p>This goes some way towards attenuating the effect but it’s obviously still some way off. This is probably because the result is very sensitive to the interaction term, and we don’t seem to be capturing that well. e.g. Here is the weighting when the interaction term is included and omitted:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>probs_int &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(S <span class="op">~</span><span class="st"> </span>A <span class="op">+</span><span class="st"> </span>Y <span class="op">+</span><span class="st"> </span>A<span class="op">:</span>Y, <span class="dt">family=</span><span class="st">"binomial"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/fitted.values.html">fitted.values</a></span>()</span>
<span id="cb25-2"><a href="#cb25-2"></a>probs_noint &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(S <span class="op">~</span><span class="st"> </span>A <span class="op">+</span><span class="st"> </span>Y, <span class="dt">family=</span><span class="st">"binomial"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/fitted.values.html">fitted.values</a></span>()</span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(Y <span class="op">~</span><span class="st"> </span>A, <span class="dt">family=</span><span class="st">"binomial"</span>, <span class="dt">subset=</span>S<span class="op">==</span><span class="dv">1</span>, <span class="dt">weight=</span><span class="dv">1</span><span class="op">/</span>probs_int))<span class="op">$</span>coef[<span class="dv">2</span>] <span class="op">%&gt;%</span><span class="st"> </span>exp</span>
<span id="cb25-4"><a href="#cb25-4"></a><span class="co">#&gt; Warning in eval(family$initialize): non-integer #successes in a binomial</span></span>
<span id="cb25-5"><a href="#cb25-5"></a><span class="co">#&gt; glm!</span></span>
<span id="cb25-6"><a href="#cb25-6"></a><span class="co">#&gt; [1] 1.015738</span></span>
<span id="cb25-7"><a href="#cb25-7"></a><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(Y <span class="op">~</span><span class="st"> </span>A, <span class="dt">family=</span><span class="st">"binomial"</span>, <span class="dt">subset=</span>S<span class="op">==</span><span class="dv">1</span>, <span class="dt">weight=</span><span class="dv">1</span><span class="op">/</span>probs_noint))<span class="op">$</span>coef[<span class="dv">2</span>] <span class="op">%&gt;%</span><span class="st"> </span>exp</span>
<span id="cb25-8"><a href="#cb25-8"></a><span class="co">#&gt; Warning in eval(family$initialize): non-integer #successes in a binomial</span></span>
<span id="cb25-9"><a href="#cb25-9"></a><span class="co">#&gt; glm!</span></span>
<span id="cb25-10"><a href="#cb25-10"></a><span class="co">#&gt; [1] 1.866911</span></span></code></pre></div>
<p>Omitting the interaction term, even though small, makes a big difference. Also the estimate of the interaction effect in risk difference terms is quite different from that simulated even though the other terms are still quite well estimated:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>coef3 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(S <span class="op">~</span><span class="st"> </span>A <span class="op">+</span><span class="st"> </span>Y <span class="op">+</span><span class="st"> </span>A<span class="op">:</span>Y)<span class="op">$</span>coef</span>
<span id="cb26-2"><a href="#cb26-2"></a>coef3[<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Logistic.html">qlogis</a></span>(coef3[<span class="dv">1</span>])</span>
<span id="cb26-3"><a href="#cb26-3"></a>coef3[<span class="dv">2</span><span class="op">:</span><span class="dv">4</span>] &lt;-<span class="st"> </span>coef3[<span class="dv">2</span><span class="op">:</span><span class="dv">4</span>] <span class="op">/</span><span class="st"> </span>(mu <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span><span class="op">-</span>mu))</span>
<span id="cb26-4"><a href="#cb26-4"></a>coef3</span>
<span id="cb26-5"><a href="#cb26-5"></a><span class="co">#&gt; (Intercept)           A           Y         A:Y </span></span>
<span id="cb26-6"><a href="#cb26-6"></a><span class="co">#&gt; -3.58889111 -0.47879527  2.24031479 -0.05408676</span></span>
<span id="cb26-7"><a href="#cb26-7"></a>coef</span>
<span id="cb26-8"><a href="#cb26-8"></a><span class="co">#&gt; (Intercept)           A           Y         A:Y </span></span>
<span id="cb26-9"><a href="#cb26-9"></a><span class="co">#&gt;  -3.5888911  -0.8487177   1.3693398   0.6406576</span></span></code></pre></div>
<p>The difference in the weighted regressions is large:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>probs4 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span>(<span class="op">~</span><span class="st"> </span>A <span class="op">+</span><span class="st"> </span>Y <span class="op">+</span><span class="st"> </span>A<span class="op">:</span>Y, <span class="dt">subset=</span>S<span class="op">==</span><span class="dv">1</span>) <span class="op">%*%</span><span class="st"> </span>coef3 <span class="op">%&gt;%</span><span class="st"> </span>plogis</span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(Y <span class="op">~</span><span class="st"> </span>A, <span class="dt">family=</span><span class="st">"binomial"</span>, <span class="dt">subset=</span>S<span class="op">==</span><span class="dv">1</span>, <span class="dt">weight=</span><span class="dv">1</span><span class="op">/</span>probs4))<span class="op">$</span>coef[<span class="dv">2</span>] <span class="op">%&gt;%</span><span class="st"> </span>exp</span>
<span id="cb27-3"><a href="#cb27-3"></a><span class="co">#&gt; Warning in eval(family$initialize): non-integer #successes in a binomial</span></span>
<span id="cb27-4"><a href="#cb27-4"></a><span class="co">#&gt; glm!</span></span>
<span id="cb27-5"><a href="#cb27-5"></a><span class="co">#&gt; [1] 1.886533</span></span>
<span id="cb27-6"><a href="#cb27-6"></a><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(Y <span class="op">~</span><span class="st"> </span>A, <span class="dt">family=</span><span class="st">"binomial"</span>, <span class="dt">subset=</span>S<span class="op">==</span><span class="dv">1</span>, <span class="dt">weight=</span><span class="dv">1</span><span class="op">/</span>probs3))<span class="op">$</span>coef[<span class="dv">2</span>] <span class="op">%&gt;%</span><span class="st"> </span>exp</span>
<span id="cb27-7"><a href="#cb27-7"></a><span class="co">#&gt; Warning in eval(family$initialize): non-integer #successes in a binomial</span></span>
<span id="cb27-8"><a href="#cb27-8"></a><span class="co">#&gt; glm!</span></span>
<span id="cb27-9"><a href="#cb27-9"></a><span class="co">#&gt; [1] 1.775638</span></span>
<span id="cb27-10"><a href="#cb27-10"></a><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(Y <span class="op">~</span><span class="st"> </span>A, <span class="dt">family=</span><span class="st">"binomial"</span>, <span class="dt">subset=</span>S<span class="op">==</span><span class="dv">1</span>, <span class="dt">weight=</span><span class="dv">1</span><span class="op">/</span>probs2))<span class="op">$</span>coef[<span class="dv">2</span>] <span class="op">%&gt;%</span><span class="st"> </span>exp</span>
<span id="cb27-11"><a href="#cb27-11"></a><span class="co">#&gt; Warning in eval(family$initialize): non-integer #successes in a binomial</span></span>
<span id="cb27-12"><a href="#cb27-12"></a><span class="co">#&gt; glm!</span></span>
<span id="cb27-13"><a href="#cb27-13"></a><span class="co">#&gt; [1] 1.015738</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#ace-inhibitor-and-covid19-association">ACE-inhibitor and COVID19 association</a></li>
      <li><a href="#simulate-to-check">Simulate to check</a></li>
      <li><a href="#weighted-regression-to-correct-for-bias">Weighted regression to correct for bias</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Gibran Hemani.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
